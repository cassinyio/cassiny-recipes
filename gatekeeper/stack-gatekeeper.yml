##
##    stack-gatekeeper.yml
##
##    Orchestration file
##
##    This is the stack that runs Cassiny.io
##    :copyright: (c) 2017, Cassiny.io OÃœ.
##    All rights reserved.
##
################################################

version: "3.4"

services:

########### CONSUL DB ###########
# https://hub.docker.com/_/consul/
  consul:
    image: consul:1.0.1
    networks:
      - cassiny-private
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      placement:
        constraints:
          - node.labels.gpu == false


########### TRAEFIK ###########
# https://hub.docker.com/r/library/traefik/
  traefik:
    image: traefik:v1.4.5
    depends_on:
      - consul
    networks:
      - cassiny-private
      - cassiny-public
    ports:
      - "8080:8080"
      - "80:80"
      - "443:443"
    volumes:
       - /var/run/docker.sock:/var/run/docker.sock
    deploy:
      restart_policy:
        condition: on-failure
      mode: replicated
      replicas: 2
      placement:
        constraints:
          - node.role == manager
          - node.labels.gpu == false
    configs:
      - source: traefik
        target: /etc/traefik/traefik.toml

configs:
  traefik:
    file: traefik.toml

networks:
    cassiny-private:
      external: True
    cassiny-public:
      external: True
